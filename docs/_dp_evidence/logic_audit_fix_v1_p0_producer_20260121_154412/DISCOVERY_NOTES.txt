# Discovery Notes: Plateau Candidates Producer

## Target: Find where winners.json is produced

### Search Results

#### winners.json write locations
```
src/control/supervisor/handlers/run_plateau.py:130: write_json_atomic(candidates_path, winners_content)
```
- This is test mode only, not production path

#### Pipeline Flow

**`src/pipeline/runner_adapter.py`**:
- Line 122: `topk_param_ids = select_topk(stage0_results, k=topk)`
- Line 124-138: Builds `winners["topk"]` list with only Top-K items
- Line 207-220: Stage1 sorts by net_profit, selects Top-K only
- Line 287-294: Stage2 converts all results to winners

**Key Finding**: `_run_stage1_job()` and `_run_stage2_job()` have full `metrics_array` from `run_grid()` but only export Top-K.

#### Artifact Writer

**`src/core/artifacts.py`**:
- Line 92: `_write_json(run_dir / "winners.json", winners)`
- Function `write_run_artifacts()` is the canonical artifact writer
- No current support for plateau_candidates.json

#### Consumer Contract

**`src/research/plateau.py`**:
- Line 114-161: `load_candidates_from_file()` expects:
  - `plateau_candidates` key (preferred)
  - `topk` key (fallback with warning if < 50)
- Required fields per candidate:
  - `params`: dict
  - `score`: float
  - Optional: `metrics`, `candidate_id`, `strategy_id`, `symbol`, `timeframe`

## Broad Candidate Universe

### Current State
- `run_grid()` returns `metrics_array` with shape `(N_params, 3)`:
  - Column 0: net_profit
  - Column 1: trades
  - Column 2: max_dd
- This is the broad universe we need to export

### Proposed Schema
```json
{
  "plateau_candidates": [
    {
      "param_id": 0,
      "params": {...},
      "score": 123.45,
      "net_profit": 123.45,
      "trades": 10,
      "max_dd": -50.0,
      "rank": 1
    }
  ],
  "metadata": {
    "source_stage": "stage1_topk",
    "count": 1000,
    "schema_version": "v1"
  }
}
```

## Implementation Decision

**Option A (CHOSEN)**: Derive from existing grid results in `runner_adapter.py`

- Modify `_run_stage1_job()` and `_run_stage2_job()` to return `plateau_candidates` alongside `winners`
- Modify `write_run_artifacts()` to accept and write `plateau_candidates.json`
- No changes to `run_grid()` itself (keeps it pure)

## Files Identified

1. `src/pipeline/runner_adapter.py` - Producer
2. `src/core/artifacts.py` - Writer
3. `src/research/plateau.py` - Consumer (already updated in L2-1)
4. `src/control/supervisor/handlers/run_research.py` - Orchestrator (may need update)
