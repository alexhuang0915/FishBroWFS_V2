
# Discovery Notes: Plateau Candidates Producer Enablement

## Finding [L2-1] Implementation Loop Closure
The Logic Audit identified that the Plateau Detection stage was falling back to `winners.json` because `plateau_candidates.json` was missing. This fallback restricted the plateau analysis to a very small set (Top-20), leading to unreliable robustness metrics.

## Key Source Files and Logic locations:

### 1. src/pipeline/runner_adapter.py (Producer Logic)
- `_run_stage1_job`: Added logic to extract the Top-1000 candidates from `run_grid` result.
- `_run_stage2_job`: Added logic to extract all candidates from the confirmation stage.
- Logic uses deterministic sorting: `score` DESC, `param_id` ASC.
- Preserves types for parameters (e.g., `channel_len` as int) to ensure consistency with `winners.json` and plateau stage expectations.

### 2. src/core/artifacts.py (Storage Logic)
- `write_run_artifacts`: Expanded to accept `plateau_candidates`.
- Implemented JSON serialization to `<run_dir>/plateau_candidates.json`.
- Added standard metadata (source_stage, count, schema_version).

### 3. src/pipeline/funnel_runner.py (Orchestration Logic)
- `run_funnel`: Propagates candidates from stage output to the artifact writer.
- Ensures each stage of the funnel (Stage 0, 1, 2) can potentially produce candidates, though typically Stage 1 (Top-K) and Stage 2 (Confirmation) are the primary sources.

## Artifact Schema Details:
```json
{
  "plateau_candidates": [
    {
      "param_id": 123,
      "params": {"channel_len": 10, "atr_len": 20, "stop_mult": 2.5},
      "score": 1500.25,
      "metrics": {"net_profit": 1500.25, "trades": 45, "max_dd": -200.0}
    },
    ...
  ],
  "metadata": {
    "source_stage": "stage1_topk",
    "count": 1000,
    "schema_version": "v1"
  }
}
```

## Consumer Contract:
The consumer (`src/research/plateau.py`) was already updated in the first part of the fix to prioritize `plateau_candidates.json`. With this producer enabled, the system now operates in the "healthy" mainline state rather than the "fallback" warning state.
