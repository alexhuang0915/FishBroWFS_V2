# Report

## Current Reality Diagram
```
RAW (FishBroData/raw)
   |
   | prepare_with_data2_enforcement → (src/control/prepare_orchestration.py)
   v
Prepared (outputs/shared/{season}/{dataset_id}/shared_manifest.json + fingerprint_index)
   |
   | resolve_features → FeatureBundle (src/control/feature_resolver.py)
   v
Loader (FeatureBundle + manifest/fingerprint metadata)
   |
   | run_wfs_with_features → (src/wfs/runner.py)
   v
Research/WFS
```

## What Exists Checklist
- **YES:** Prepare entrypoint exists (`src/control/supervisor/handlers/build_data.py`).
- **YES:** Prepare is exposed as a job handler type (`BuildDataHandler` registered via `control/supervisor`).
- **YES:** Prepare reads RAW from `FishBroData/raw` via `_find_txt_path_for_feed` and `prepare_orchestration.py`.
- **YES:** Prepare writes prepared outputs to `outputs/shared/{season}/{dataset_id}` and returns manifest paths in `control/shared_build.py`.
- **YES:** Manifest exists as `shared_manifest.json` with self-hash logic in `control/shared_manifest.py`.
- **YES:** Fingerprint index is generated by `write_fingerprint_index` and stored under `outputs/fingerprints/{season}/{dataset_id}/fingerprint_index.json` (`control/fingerprint_store.py`).
- **YES:** Range extraction (`append_range`, `earliest_changed_day`) is captured in the manifest payload built in `control/shared_build.py`.
- **YES:** Timezone/session handling is encoded in `core/resampler.get_session_spec_for_dataset`, with fallback `Asia/Taipei` session specs.
- **YES:** Loader consumes prepared outputs via `resolve_features` in `src/control/feature_resolver.py` and never reads raw TXT files directly.
- **YES:** Loader depends on manifest/fingerprint contracts before assembling a `FeatureBundle` and will trigger `build_shared` when they are missing.
- **YES:** Governance/policy hooks guard research jobs through `evaluate_preflight`/`evaluate_postflight` in `src/control/policy_enforcement.py` and emit `policy_check.json`.

## Gaps / Risks
- **Hard-coded season/timeframe in the job handler (P0 correctness):** `BuildDataHandler` always invokes `prepare_with_data2_enforcement` with `season="2026Q1"` (and default timeframe 60m) regardless of `params`, so the handler cannot prepare arbitrary seasons/datasets. The fix belongs in `src/control/supervisor/handlers/build_data.py` where `season`, `txt_path`, and other dataset metadata should flow from the job spec.
- **Unconfigurable raw path (P1 productization):** `_find_txt_path_for_feed` assumes raw files live under `FishBroData/raw` inside the repo with no override or dataset-driven descriptor. When deployments store raw feeds elsewhere, the prepare job silently fails to locate the dataset. Introduce a configurable raw-data registry or allow the dataset spec to declare its TXT URI (`src/control/prepare_orchestration.py`).

## Recommended Next Phase (Decision)
Backend prepare + loader plumbing already exists, but there is no documented Roo admission surface that wires `BuildDataHandler`/`prepare_with_data2_enforcement` into the UI/control-station workflow. Aligning the evidence chain with the Roo UI (Phase D2 UI Admission) will let Roo builders trigger builds for any season/dataset, surface policy artifacts, and verify this pipeline end-to-end before moving to downstream research jobs.
