# Phase 0 – Discovery

## D0.1 `make up` Entrypoint Chain

**Makefile target `up`** (lines 82-111):
- Starts backend via `scripts/run_stack.py run` if not healthy.
- Waits for health check on `SUP_HEALTH` (http://127.0.0.1:8000/health).
- Launches Desktop UI via `scripts/desktop_launcher.py`.

**Desktop launcher** (`scripts/desktop_launcher.py`):
- Sets Qt platform (Wayland/XCB).
- Imports `ControlStation` from `src/gui/desktop/control_station`.
- Creates QApplication, loads stylesheet, instantiates `ControlStation`, shows window.

**Main window class**: `ControlStation` (`src/gui/desktop/control_station.py`).

## D0.2 Workstation Tab Container and Tab Registration

**Tab container**: `QTabWidget` named `self.tab_widget` (line 159).

**Tab registration** (lines 165-182):
- Instantiates 8 tab objects:
  1. `OpTab` ("Operation")
  2. `ReportTab` ("Report")
  3. `RegistryTab` ("Strategy Library")
  4. `AllocationTab` ("Portfolio")
  5. `AuditTab` ("Audit")
  6. `PortfolioAdmissionTab` ("Portfolio Admission")
  7. `GateSummaryDashboardTab` ("Gate Dashboard")
  8. `BarPrepareTab` ("Bar Prepare")
- Adds them in that order.

**Mapping**: `_tab_index_by_tool` and `_tab_by_tool` dictionaries map tool IDs to indices.

**Step flow header**: Removed (single navigation layer). `self.step_flow_header = None`.

## D0.3 Current Implementations of 3 Main Tabs

### BarPrepare Tab (`src/gui/desktop/tabs/bar_prepare_tab.py`)
- **UI Contract**: Three summary panels (RAW INPUT, PREPARE PLAN, BAR INVENTORY) with modal dialogs.
- **Input**: Raw source selector via `RawInputDialog`, timeframe enum not fixed (currently uses `prepare_plan.timeframes`).
- **Execute**: "BUILD ALL DATA" button submits `BUILD_DATA` jobs.
- **Monitor**: Build status panel with progress, job IDs, errors.
- **Output**: Right panel shows inventory summary (parquet coverage, bar count, issues).
- **Registry/Config Sync**: Not implemented; mismatch detection missing.
- **Confirm Button**: "CONFIRM" button marks step as confirmed (wizard semantics).

### Operation Tab (`src/gui/desktop/tabs/op_tab.py`)
- **UI Contract**: Adapter wrapping `OpTabRefactored` (`src/gui/desktop/tabs/op_tab_refactored.py`).
- **Input**: Card‑based selectors for strategy, timeframe, instrument, mode, date range.
- **Execute**: "RUN STRATEGY" button submits job.
- **Monitor**: Job tracker with polling, stall detection (30s "STALLED?", 120s "LIKELY STALLED").
- **Output**: Gate summary widget, but no in‑tab output summary for DONE jobs (requires switching to audit tab).
- **Polling**: `start_polling()` with `poll_interval_ms = 2000`.
- **Stall detection**: `_update_stall_label` in `op_tab_refactored.py`.
- **Progress mapping**: `_progress_for_job` maps status to phase percentages.

### Portfolio Tab (`src/gui/desktop/tabs/allocation_tab.py`)
- **UI Contract**: Portfolio Backtest Master Console.
- **Input**: Components selector from completed jobs, season dropdown, date range intersection.
- **Execute**: "RUN PORTFOLIO" button submits portfolio build job.
- **Monitor**: Live status panel with progress, stall detection, diagnostics.
- **Output**: "View Portfolio Report" button routes to audit tab.
- **Polling**: `start_polling()` with `poll_interval_ms = 2000`.
- **Stall detection**: `_update_stall_label` (same logic as OpTab).
- **Component gating**: Requires registered + prepared instruments.

## D0.4 SSOT Locations

### Registry Instruments/Timeframes
- **Config files**: `configs/registry/instruments.yaml`, `configs/registry/timeframes.yaml`.
- **Python APIs**: `src/config/registry/instruments.py` (`load_instruments`), `src/config/registry/timeframes.py` (`load_timeframes`).
- **Supervisor endpoints**: `GET /api/v1/registry/instruments`, `GET /api/v1/registry/timeframes` (via `supervisor_client.get_registry_instruments/timeframes`).

### Prepared Data Index / Inventory
- **File**: `outputs/_runtime/bar_prepare_index.json` (generated by BarPrepare).
- **Used by**: `AllocationTab.refresh_prepared_index`, `BarPrepareTab` (inventory summary).

### Job Submit Endpoints
- **Supervisor client**: `submit_job(payload)` (generic), `post_portfolio_build(request_payload)` for portfolios.
- **API routes**: `POST /api/v1/jobs` (see `src/control/api.py`).

### Jobs List Endpoint
- **Supervisor client**: `get_jobs()`, `get_outputs_summary()`.
- **API route**: `GET /api/v1/jobs`.

### Portfolio Submit Endpoint
- **Supervisor client**: `post_portfolio_build`.
- **API route**: `POST /api/v1/portfolio/build`.

### Artifact/Report/Gate/Verdict Surfaces
- **Artifacts**: `get_artifacts(job_id)`.
- **Report**: `get_strategy_report_v1(job_id)`.
- **Gate summary**: `fetch_gate_summary()` (widget), `get_cross_job_gate_summary_service`.
- **Verdict**: Gate cards in `GateSummaryWidget`.

## D0.5 Existing Tests Covering GUI Tabs, Polling, Stall, Readiness

### GUI Tab Tests
- `tests/gui_desktop/test_op_tab_cards.py` – card‑based UI, stall detection.
- `tests/gui_desktop/test_portfolio_tab_master_console.py` – component gating, date range intersection, run submission.
- `tests/gui_desktop/test_analytics_tabs_clickable.py` – tab enabling.
- `tests/gui/desktop/tabs/test_gate_summary_dashboard_tab.py` – gate dashboard.

### Polling & Stall Detection Tests
- `test_stall_detection_labels` in `test_op_tab_cards.py`.
- `test_progress_mapping_and_stall_labels` in `test_portfolio_tab_master_console.py`.

### Readiness Tests
- `tests/gui_desktop/test_data_readiness_service.py` – data readiness gates.
- `tests/gui_desktop/test_prepare_buttons_state.py` – prepare button states.

### Other Relevant Tests
- `tests/gui_desktop/test_artifact_navigator_ui.py` – artifact navigation.
- `tests/gui_desktop/test_context_feeds_multiselect.py` – UI selectors.

## Summary of Current State vs Runnable Requirements

| Requirement | Current Status |
|-------------|----------------|
| **Only 3 main tabs** | 8 tabs currently present. |
| **BarPrepare closed loop** | Partial: has input, execute, monitor, output but missing registry sync and fixed timeframe enum. |
| **Operation closed loop** | Partial: has input, execute, monitor, but output summary not in same tab (requires audit tab). |
| **Portfolio closed loop** | Partial: has input, execute, monitor, output via routing to audit tab. |
| **Polling + stall detection** | Present in OpTab and AllocationTab. |
| **Registry mismatch resolution** | Not implemented in BarPrepare. |
| **Progress mapping honesty** | Present (phase‑based). |
| **Smoke test** | Not implemented. |

**Next Phase**: UI Surface Lockdown (reduce to 3 tabs).

## Phase 1 – UI Surface Lockdown (Completed)

### Changes Applied
- Modified `src/gui/desktop/control_station.py` to keep only three visible tabs: **Bar Prepare**, **Operation**, **Portfolio**.
- Hidden tabs (Report, Registry, Audit, Portfolio Admission, Gate Dashboard) are instantiated but not added to the tab widget, preserving internal routing.
- Updated tab mapping dictionaries and step‑tool mappings accordingly.
- Added regression test `test_control_station_has_only_three_visible_tabs` to lock the three‑tab UI surface.

### Verification
- Static analysis confirms exactly three `addTab` calls.
- The UI now presents exactly three main tabs, satisfying the "only 3 main tabs" requirement.

### Next Phase
Proceed to **Phase 2 – Closed‑loop Enhancements** for each of the three tabs.