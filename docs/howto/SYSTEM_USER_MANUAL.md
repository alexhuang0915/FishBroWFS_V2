# FishBroWFS 系統使用者手冊

**版本:** 1.0 (2026 年版)
**目標讀者:** 操作員、研究員、稽核員

---

## 1. FishBroWFS 是什麼（以及不是什麼）

**FishBroWFS** 是一個 **量化研究作業系統 (Research Operating System)**。它的設計目的是管理量化研究的完整生命週期，從策略構想到投資組合建構，直至最終部署。

### 目的
其主要目的是 **治理 (Governance) 與 可重現性 (Reproducibility)**。不同於臨時編寫的腳本或筆記本 (Notebooks)，FishBroWFS 將每一個動作都視為正式且被記錄的事件。目標是讓研究員能夠在 *安全* 的前提下快速推進，確信系統會保留決策背後原因的完整稽核軌跡。

### 它不是什麼
*   **不是腳本執行器**: 你不再是「執行腳本」。你是向一個受監管的引擎提交 **作業 (Jobs)**。
*   **不是黑盒子**: 每一個產出都可以追溯到確切的輸入設定與原始碼版本。
*   **不是沙盒**: 這裡強制執行的限制是為了反映生產環境的現實。如果在這邊失敗，代表在生產環境也會失敗。

**心智模型**: 將其視為你研究工廠的「駕駛艙」。你是飛行員；系統負責管理引擎、燃料和飛行日誌。

---

## 2. 核心概念 (詞彙表)

*   **Config (設定)**: 輸入端。定義 *執行內容* 的 YAML 檔案（例如：策略參數、時間範圍、商品池）。設定檔是在不動用程式碼的情況下，改變執行行為的唯一方式。
*   **Registry (註冊表)**: 可用邏輯的目錄。包含 **策略 (Strategies)**（交易邏輯）與 **資料集 (Datasets)**（市場數據）。有效的設定檔必須引用註冊表中存在的項目。
*   **Template (模板)**: 作為起點的「黃金標準」設定。永遠不要從零開始；請複製模板。
*   **Job (作業)**: 工作的最小單位。每一次的回測、最佳化或資料寫入都是一個擁有唯一 ID (UUID) 的作業。
*   **Artifact (產物)**: 作業的輸出結果。不可變更的檔案（JSON, Parquet），用來證明發生了什麼。一旦寫入，就永遠不會被修改，只能讀取。
*   **Research Run (研究執行)**: 一種特定類型的作業，用於在歷史數據上執行交易策略。
*   **Portfolio Decision (投資組合決策)**: 將策略納入或排除於投資組合的正式選擇，背後有證據（產物）支持。
*   **SSOT (單一事實來源)**: 檔案系統（產物）與資料庫的結合。系統狀態是絕對的；記憶體中不存在「隱藏」狀態。
*   **Governance / Contracts (治理 / 契約)**: 「守護者」層。一組驗證系統行為是否正確的規則。如果治理契約失敗，系統會強制停止以防止資料損壞。

---

## 3. 系統流程 (端對端)

研究想法的生命週期遵循一條嚴格的線性路徑：

1.  **設定 (Configuration)**: 準備一個 YAML 設定檔（通常複製自模板），定義假設（例如：「在市場 Y 上執行策略 X」）。
2.  **提交作業 (Job Submission)**: 將設定檔作為 **作業 (Job)** 提交給引擎。
3.  **執行 (Execution)**: 引擎接收作業並驗證輸入。若驗證通過，則啟動工作程序 (Worker) 執行邏輯。
4.  **生成產物 (Artifact Generation)**: 工作程序生成 **產物 (Artifacts)**（權益曲線、日誌、交易清單）並寫入 `outputs/` 目錄。
5.  **檢查 (Inspection)**: 操作員在 UI (Ops Tab) 中查看這些產物以評斷品質。
6.  **決策 (Decision)**: 如果結果理想，操作員將其「晉升 (Promote)」。系統隨後評估其是否適合放入投資組合 (Portfolio Tab)。
7.  **匯出 (Export)**: 若被採納，該設定將被「凍結 (Frozen)」並匯出以供部署。

---

## 4. 設定指南 (如何安全使用 Configs)

`configs/` 目錄是研究員的工作空間。

### 結構
*   `configs/strategies/`: 放置你的策略定義。
*   `configs/registry/`: (進階) 定義底層系統綁定。
*   `configs/profiles/`: 定義環境設定（例如：「快速開發」、「完整生產」）。

### 安全規則
1.  **模板為王**: 務必複製 `research_template_v1.yaml` 或類似檔案。不要手寫檔頭。
2.  **依慣例不可變**: 一旦設定檔被用於重大決策，**請勿編輯它**。請建立 `strategy_v2.yaml`。這能保留 `v1` 的歷史紀錄。
3.  **無重複**: 永遠不要在同一個檔案重複定義相同的參數。載入器會拒絕執行。

**常見錯誤**: 在作業執行 *期間* 編輯設定檔。雖然系統會在提交時對設定進行快照以保護你，但這是壞習慣。

---

## 5. 作業與執行模型

在 FishBroWFS 中，**萬物皆作業 (Everything is a Job)**。

*   **為什麼？** 為了確保非同步的穩定性。UI 永遠不會自己「執行」邏輯。它要求後端「排程一個作業」。這意味著 UI 可以崩潰，你可以闔上筆電，但作業仍在背景安全地執行。

### 作業生命週期
1.  **PENDING (等待中)**: 已提交至佇列。
2.  **RUNNING (執行中)**: 工作程序已接手處理。
3.  **COMPLETED (已完成)**: 成功結束。產物已就緒。
4.  **FAILED (失敗)**: 發生錯誤。請檢查 `stack_stdout.log` 或 UI 日誌。

**Supervisor (監督者)** 是負責追蹤這些狀態的系統協調者。

---

## 6. 產物與證據 (Artifacts & Evidence)

產物是你工作的 **證據**。它們位於 `outputs/`。

### 關鍵特徵
*   **不可變 (Immutable)**: 系統防止覆寫已完成作業的產物。
*   **可追溯 (Traceable)**: 每個產物都包含 `metadata.json`，連結回 **設定內容**、**Git Commit Hash** 和 **時間**。
*   **可攜帶 (Portable)**: 你可以打包產物資料夾傳給同事。他們載入後看到的內容會與你完全一致。

**重要性**: 在稽核中，你展示的不是「程式碼」，而是「產物」。它們證明了該程式碼在該時間點以該參數執行並產出了該結果。

---

## 7. 使用介面 (操作視角)

UI 分為 5 個分頁，對應工作流程：

1.  **Registry Tab (註冊表)**: **「圖書館」**。瀏覽可用的設定模板、策略和資料集。用此確認你的輸入是否存在。
2.  **Op Tab (操作概覽)**: **「塔台」**。查看你的作業狀態。這裡是啟動新執行和確認是否成功的地方。
3.  **Ops Tab (詳細內容)**: **「顯微鏡」**。深入查看特定執行作業。檢視詳細產物如圖表和日誌。
4.  **Allocation Tab (配置)**: **「投資組合」**。查看「大局」。個別策略如何組合？此分頁管理投資組合邏輯。
5.  **Bar Prepare Tab (資料準備)**: **「工廠」**。用於匯入和清理原始數據的工具。

**操作提示**: 不要只盯著進度條。使用 Op Tab 中的「Logs」視圖，可以即時看到引擎的「思考過程」。

---

## 8. 研究 → 投資組合決策迴圈

這是最關鍵的人機互動階段。

1.  **研究**: 你執行回測。結果看起來不錯（高夏普值、低回撤）。
2.  **閘門 (Gating)**: 系統自動執行 **閘門**（政策檢查）。槓桿是否太高？數據是否稀疏？
3.  **晉升 (Promotion)**: 如果通過閘門，你可以「晉升」該結果。
4.  **可採納性 (Admissibility)**: 投資組合引擎計算加入此新策略是否改善了 *整體* 投資組合。它會檢查相關性和分散效果。
5.  **理由 (Justification)**: 系統記錄 **決策卡 (Decision Cards)**。「採納是因為分散了風險」或「拒絕是因為與策略 A 高度相關」。

你不是在挑選贏家；你是在建立一個團隊。

---

## 9. 測試與治理模型 (使用者視角)

你會看到關於「測試」或「檢查」的引用。為什麼要在乎？

*   **核心測試 (`make test-core`)**: 保證引擎沒有損壞。如果這些失敗，不要相信任何結果。
*   **治理測試 (`make test-governance`)**: 保證 **規則** 被遵守。這些檢查諸如「無寫死路徑」或「Schema 合規性」。
*   **遺產測試 (`make test-legacy`)**: 歷史檢查。只有在進行深度重構時才相關。

**經驗法則**: 如果 `make check-fast` 失敗，系統就不安全。請停止並修復它。

---

## 10. 常見工作流 (範例)

### A. 執行新研究
1.  前往 **Registry Tab**。找到 `research_template_v1`。
2.  複製內容，編輯參數（例如：更改 `lookback_window`），另存為 `my_new_strategy.yaml`。
3.  前往 **Op Tab**。點擊 "Submit Job" -> "Research"。選擇你的檔案。
4.  等待 "COMPLETED"。檢查權益曲線產物。

### B. 安全建立投資組合
1.  在 **Ops Tab** 找出成功的研究作業。
2.  使用 "Promote to Portfolio" 動作。
3.  前往 **Allocation Tab**。
4.  執行 "Re-Optimize Portfolio"。系統將匯入新候選者並輸出新的目標配置。

### C. 驗證系統健康
1.  執行 `make doctor`。檢查連接埠、資料庫連線和環境健康。
2.  執行 `make check-fast`。驗證邏輯完整性。

---

## 11. 安全保證與不變性

FishBroWFS 提供強大的保證：

1.  **無聲失敗絕不發生**: 如果計算遇到模糊性（例如：對齊數據時間戳），它會 **崩潰** 而不是猜測。我們寧願作業崩潰，也不要錯誤的獲利數字。
2.  **輸入純淨**: 策略無法看到「未來數據」（前視偏差保護）。引擎嚴格執行時間視窗存取限制。
3.  **隔離**: 策略 A 無法讀取策略 B 的記憶體。
4.  **確定性重播**: 如果你用相同的程式碼版本重新執行相同的設定檔，你會得到位元等級完全相同的產物。

---

## 12. 異常排除

1.  **作業卡在 PENDING？** 檢查 Supervisor 是否在執行 (`make status`)。工作程序池可能已滿。
2.  **"Artifact Not Found"？** 作業是否無聲失敗了？檢查 `stack_stdout.log`。作業可能在寫入輸出前就崩潰了。
3.  **UI 感覺卡住？** 後端可能正忙於處理大檔案。UI 是解耦的；請重新整理頁面。
4.  **數據看起來怪怪的？** 檢查 **Bar Prepare Tab**。驗證原始數據匯入品質。垃圾進，垃圾出。

**黃金法則**: 如果你懷疑有 Bug，請保留產物。它們是除錯所需的「黑盒子飛行記錄器」。

---

## 13. 附錄：哲學

*「信任即效率。」*
我們建造這台重型機器不是為了拖慢你，而是為了讓你即時信任結果。如果系統說「通過」，這意味著已經發生了一千次檢查。這讓你能夠擴展你的研究心智容量，而不會被數據對齊或實作 Bug 的恐懼所困擾。
