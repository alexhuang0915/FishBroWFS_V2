"""
Portfolio Report Widget for CTA-grade Allocation Decision Desk.

Professional display for PortfolioReportV1 with:
- Allocation Summary Panel (risk used vs budget, counts, avg corr, worst pair)
- Interactive Correlation Matrix (hover + click highlight)
- Admission Timeline (step-by-step elimination narrative)
- Portfolio Actions: Export JSON, Open Admission Evidence, Export PNG (charts)
"""

import json
import logging
import math
from typing import Dict, Any, Optional, List, Tuple
from datetime import datetime
from pathlib import Path

from PySide6.QtCore import Qt, Signal, Slot, QSize, QRect, QUrl
from PySide6.QtWidgets import (
    QWidget, QVBoxLayout, QHBoxLayout, QGridLayout, QFormLayout,
    QLabel, QPushButton, QTableWidget, QTableWidgetItem,
    QGroupBox, QScrollArea, QSizePolicy, QComboBox,
    QButtonGroup, QToolButton, QFileDialog, QMessageBox,
    QStackedWidget, QFrame, QSplitter, QHeaderView, QAbstractItemView
)
from PySide6.QtGui import (
    QPainter, QPixmap, QDesktopServices, QColor, QFont, QPen, QBrush
)

from ...widgets.metric_cards import MetricCard, MetricRow
from ...widgets.charts.heatmap import HeatmapWidget
from ...services.supervisor_client import (
    get_portfolio_report_v1, get_portfolio_artifacts, 
    reveal_portfolio_admission_path, SupervisorClientError
)

logger = logging.getLogger(__name__)


class PortfolioReportWidget(QWidget):
    """
    CTA-grade Portfolio Report Widget (Allocation Decision Desk).
    
    Displays PortfolioReportV1 payload with professional analytics.
    """
    
    # Signals
    log_signal = Signal(str)
    pair_selected = Signal(str, str, float)  # strat_a, strat_b, correlation
    
    def __init__(self, portfolio_id: str, report_data: Dict[str, Any]):
        """
        Initialize the portfolio report widget.
        
        Args:
            portfolio_id: The portfolio ID for this report
            report_data: The PortfolioReportV1 payload
        """
        super().__init__()
        self.portfolio_id = portfolio_id
        self.report_data = report_data
        self.metric_cards: List[MetricCard] = []
        self.selected_pair: Optional[Tuple[str, str, float]] = None
        self.admitted_table_items = {}  # strategy_name -> table items for highlighting
        self.rejected_table_items = {}  # strategy_name -> table items for highlighting
        
        self.setup_ui()
        self.populate_data()
    
    def setup_ui(self):
        """Initialize the UI components."""
        main_layout = QVBoxLayout(self)
        main_layout.setContentsMargins(12, 12, 12, 12)
        main_layout.setSpacing(12)
        
        # Toolbar
        self.setup_toolbar(main_layout)
        
        # Header section
        self.setup_header(main_layout)
        
        # Headline metrics row
        self.setup_metrics_row(main_layout)
        
        # Create splitter for main content
        splitter = QSplitter(Qt.Horizontal)
        
        # Left panel: Summary, Timeline, Tables
        left_widget = QWidget()
        left_layout = QVBoxLayout(left_widget)
        left_layout.setContentsMargins(0, 0, 0, 0)
        left_layout.setSpacing(12)
        
        # Admission Timeline
        self.setup_timeline(left_layout)
        
        # Tables (Admitted & Rejected)
        self.setup_tables(left_layout)
        
        # Right panel: Correlation Heatmap
        right_widget = QWidget()
        right_layout = QVBoxLayout(right_widget)
        right_layout.setContentsMargins(0, 0, 0, 0)
        right_layout.setSpacing(12)
        
        # Correlation Heatmap
        self.setup_heatmap(right_layout)
        
        # Selected pair display
        self.setup_selected_pair_display(right_layout)
        
        # Add widgets to splitter
        splitter.addWidget(left_widget)
        splitter.addWidget(right_widget)
        splitter.setSizes([400, 600])  # Initial sizes
        
        main_layout.addWidget(splitter, 1)  # Take remaining space
    
    def setup_toolbar(self, parent_layout: QVBoxLayout):
        """Setup the top toolbar with export buttons."""
        toolbar = QWidget()
        toolbar.setStyleSheet("background-color: #2A2A2A; border-radius: 4px; padding: 4px;")
        toolbar_layout = QHBoxLayout(toolbar)
        toolbar_layout.setContentsMargins(8, 4, 8, 4)
        
        # Export JSON button
        self.export_json_btn = QPushButton("üìä Export JSON")
        self.export_json_btn.setToolTip("Export report data as JSON file")
        self.export_json_btn.clicked.connect(self.export_json)
        
        # Export PNG button
        self.export_png_btn = QPushButton("üñºÔ∏è Export PNG (Charts)")
        self.export_png_btn.setToolTip("Export charts as PNG image")
        self.export_png_btn.clicked.connect(self.export_png)
        
        # Open Admission Evidence button
        self.open_evidence_btn = QPushButton("üìÅ Open Admission Evidence")
        self.open_evidence_btn.setToolTip("Open admission evidence folder for this portfolio")
        self.open_evidence_btn.clicked.connect(self.open_admission_evidence)
        
        # Style buttons
        for btn in [self.export_json_btn, self.export_png_btn, self.open_evidence_btn]:
            btn.setStyleSheet("""
                QPushButton {
                    background-color: #3A3A3A;
                    color: #E6E6E6;
                    border: 1px solid #555555;
                    border-radius: 4px;
                    padding: 6px 12px;
                    font-size: 11px;
                }
                QPushButton:hover {
                    background-color: #4A4A4A;
                    border-color: #3A8DFF;
                }
                QPushButton:pressed {
                    background-color: #2A2A2A;
                }
            """)
        
        toolbar_layout.addWidget(self.export_json_btn)
        toolbar_layout.addWidget(self.export_png_btn)
        toolbar_layout.addWidget(self.open_evidence_btn)
        toolbar_layout.addStretch()
        
        parent_layout.addWidget(toolbar)
    
    def setup_header(self, parent_layout: QVBoxLayout):
        """Setup the report header section."""
        header_group = QGroupBox("Portfolio Allocation Decision Desk")
        header_group.setStyleSheet("""
            QGroupBox {
                font-weight: bold;
                border: 2px solid #4CAF50;
                background-color: #1E1E1E;
                margin-top: 5px;
                padding-top: 8px;
                font-size: 12px;
            }
            QGroupBox::title {
                subcontrol-origin: margin;
                left: 8px;
                padding: 0 4px 0 4px;
                color: #E6E6E6;
            }
        """)
        
        header_layout = QGridLayout()
        
        # Basic info from report
        portfolio_id = self.report_data.get('portfolio_id', 'Unknown')
        created_at = self.report_data.get('created_at', 'N/A')
        
        header_layout.addWidget(QLabel(f"<b>Portfolio ID:</b> {portfolio_id}"), 0, 0)
        header_layout.addWidget(QLabel(f"<b>Created:</b> {created_at}"), 0, 1)
        
        # Parameters if available
        params = self.report_data.get('parameters', {})
        if params:
            risk_budget = params.get('portfolio_risk_budget_max', 'N/A')
            corr_threshold = params.get('max_pairwise_correlation', 'N/A')
            header_layout.addWidget(QLabel(f"<b>Risk Budget:</b> {risk_budget}"), 1, 0)
            header_layout.addWidget(QLabel(f"<b>Corr Threshold:</b> {corr_threshold}"), 1, 1)
        
        header_group.setLayout(header_layout)
        parent_layout.addWidget(header_group)
    
    def setup_metrics_row(self, parent_layout: QVBoxLayout):
        """Setup the headline metric cards row."""
        self.metrics_row = MetricRow()
        parent_layout.addWidget(self.metrics_row)
    
    def setup_timeline(self, parent_layout: QVBoxLayout):
        """Setup admission timeline section."""
        timeline_group = QGroupBox("Admission Timeline")
        timeline_group.setStyleSheet("""
            QGroupBox {
                font-weight: bold;
                border: 1px solid #555555;
                background-color: #1E1E1E;
                margin-top: 5px;
                padding-top: 8px;
                font-size: 11px;
            }
            QGroupBox::title {
                subcontrol-origin: margin;
                left: 8px;
                padding: 0 4px 0 4px;
                color: #E6E6E6;
            }
        """)
        
        timeline_layout = QVBoxLayout()
        timeline_layout.setContentsMargins(8, 8, 8, 8)
        timeline_layout.setSpacing(6)
        
        self.timeline_widget = QWidget()
        self.timeline_inner_layout = QVBoxLayout(self.timeline_widget)
        self.timeline_inner_layout.setContentsMargins(0, 0, 0, 0)
        self.timeline_inner_layout.setSpacing(4)
        
        # Scroll area for timeline
        scroll = QScrollArea()
        scroll.setWidgetResizable(True)
        scroll.setWidget(self.timeline_widget)
        scroll.setMaximumHeight(200)
        scroll.setStyleSheet("""
            QScrollArea {
                border: none;
                background-color: #1E1E1E;
            }
        """)
        
        timeline_layout.addWidget(scroll)
        timeline_group.setLayout(timeline_layout)
        parent_layout.addWidget(timeline_group)
    
    def setup_tables(self, parent_layout: QVBoxLayout):
        """Setup admitted and rejected strategy tables."""
        tables_group = QGroupBox("Strategy Decisions")
        tables_group.setStyleSheet("""
            QGroupBox {
                font-weight: bold;
                border: 1px solid #555555;
                background-color: #1E1E1E;
                margin-top: 5px;
                padding-top: 8px;
                font-size: 11px;
            }
            QGroupBox::title {
                subcontrol-origin: margin;
                left: 8px;
                padding: 0 4px 0 4px;
                color: #E6E6E6;
            }
        """)
        
        tables_layout = QVBoxLayout()
        
        # Tab widget for admitted/rejected
        self.tables_stack = QStackedWidget()
        
        # Admitted table
        self.admitted_table = QTableWidget()
        self.setup_table_style(self.admitted_table)
        self.admitted_table.setHorizontalHeaderLabels(["Strategy", "Weight", "Score", "Risk"])
        self.admitted_table.horizontalHeader().setStretchLastSection(True)
        self.admitted_table.setSelectionBehavior(QAbstractItemView.SelectRows)
        self.admitted_table.setSelectionMode(QAbstractItemView.SingleSelection)
        self.admitted_table.itemSelectionChanged.connect(self.on_admitted_row_selected)
        
        # Rejected table
        self.rejected_table = QTableWidget()
        self.setup_table_style(self.rejected_table)
        self.rejected_table.setHorizontalHeaderLabels(["Strategy", "Reason", "Score"])
        self.rejected_table.horizontalHeader().setStretchLastSection(True)
        self.rejected_table.setSelectionBehavior(QAbstractItemView.SelectRows)
        self.rejected_table.setSelectionMode(QAbstractItemView.SingleSelection)
        self.rejected_table.itemSelectionChanged.connect(self.on_rejected_row_selected)
        
        # Tab buttons
        tab_buttons = QWidget()
        tab_layout = QHBoxLayout(tab_buttons)
        tab_layout.setContentsMargins(0, 0, 0, 0)
        
        self.admitted_tab_btn = QPushButton("Admitted")
        self.rejected_tab_btn = QPushButton("Rejected")
        
        for btn in [self.admitted_tab_btn, self.rejected_tab_btn]:
            btn.setCheckable(True)
            btn.setStyleSheet("""
                QPushButton {
                    background-color: #3A3A3A;
                    color: #E6E6E6;
                    border: 1px solid #555555;
                    border-radius: 3px;
                    padding: 6px 12px;
                    font-size: 11px;
                }
                QPushButton:checked {
                    background-color: #4CAF50;
                    color: white;
                }
                QPushButton:hover {
                    background-color: #4A4A4A;
                }
            """)
            tab_layout.addWidget(btn)
        
        self.admitted_tab_btn.setChecked(True)
        self.admitted_tab_btn.clicked.connect(lambda: self.tables_stack.setCurrentWidget(self.admitted_table))
        self.rejected_tab_btn.clicked.connect(lambda: self.tables_stack.setCurrentWidget(self.rejected_table))
        
        tab_layout.addStretch()
        
        # Add tables to stack
        self.tables_stack.addWidget(self.admitted_table)
        self.tables_stack.addWidget(self.rejected_table)
        
        tables_layout.addWidget(tab_buttons)
        tables_layout.addWidget(self.tables_stack)
        
        tables_group.setLayout(tables_layout)
        parent_layout.addWidget(tables_group, 1)  # Take remaining space
    
    def setup_table_style(self, table: QTableWidget):
        """Apply consistent styling to tables."""
        table.setAlternatingRowColors(True)
        table.setStyleSheet("""
            QTableWidget {
                background-color: #1E1E1E;
                color: #E6E6E6;
                border: 1px solid #555555;
                font-size: 11px;
            }
            QTableWidget::item {
                padding: 4px;
            }
            QHeaderView::section {
                background-color: #2A2A2A;
                color: #E6E6E6;
                border: 1px solid #555555;
                padding: 4px;
                font-weight: bold;
            }
            QTableWidget::item:selected {
                background-color: #1a237e;
            }
        """)
    
    def setup_heatmap(self, parent_layout: QVBoxLayout):
        """Setup correlation heatmap."""
        heatmap_group = QGroupBox("Correlation Matrix")
        heatmap_group.setStyleSheet("""
            QGroupBox {
                font-weight: bold;
                border: 1px solid #555555;
                background-color: #1E1E1E;
                margin-top: 5px;
                padding-top: 8px;
                font-size: 11px;
            }
            QGroupBox::title {
                subcontrol-origin: margin;
                left: 8px;
                padding: 0 4px 0 4px;
                color: #E6E6E6;
            }
        """)
        
        heatmap_layout = QVBoxLayout()
        
        self.heatmap = HeatmapWidget("Strategy Correlation Matrix")
        self.heatmap.setMinimumHeight(400)
        
        # Connect heatmap signals
        self.heatmap.cell_hovered.connect(self.on_heatmap_hover)
        self.heatmap.cell_clicked.connect(self.on_heatmap_click)
        
        heatmap_layout.addWidget(self.heatmap)
        heatmap_group.setLayout(heatmap_layout)
        parent_layout.addWidget(heatmap_group, 1)  # Take remaining space
    
    def setup_selected_pair_display(self, parent_layout: QVBoxLayout):
        """Setup display for selected correlation pair."""
        pair_group = QGroupBox("Selected Pair")
        pair_group.setStyleSheet("""
            QGroupBox {
                font-weight: bold;
                border: 1px solid #555555;
                background-color: #1E1E1E;
                margin-top: 5px;
                padding-top: 8px;
                font-size: 11px;
            }
            QGroupBox::title {
                subcontrol-origin: margin;
                left: 8px;
                padding: 0 4px 0 4px;
                color: #E6E6E6;
            }
        """)
        
        pair_layout = QVBoxLayout()
        pair_layout.setContentsMargins(8, 8, 8, 8)
        
        self.selected_pair_label = QLabel("No pair selected")
        self.selected_pair_label.setStyleSheet("color: #9A9A9A; font-size: 12px;")
        self.selected_pair_label.setWordWrap(True)
        
        pair_layout.addWidget(self.selected_pair_label)
        pair_group.setLayout(pair_layout)
        parent_layout.addWidget(pair_group)
    
    def populate_data(self):
        """Populate all UI components with report data."""
        try:
            # Populate headline metrics
            self.populate_metrics()
            
            # Populate correlation heatmap
            self.populate_heatmap()
            
            # Populate admission timeline
            self.populate_timeline()
            
            # Populate strategy tables
            self.populate_tables()
            
        except Exception as e:
            logger.error(f"Error populating report data: {e}")
            self.log_signal.emit(f"Error loading report data: {e}")
    
    def populate_metrics(self):
        """Populate headline metric cards."""
        try:
            # Extract data from report
            admission_summary = self.report_data.get('admission_summary', {})
            correlation = self.report_data.get('correlation', {})
            matrix = correlation.get('matrix',